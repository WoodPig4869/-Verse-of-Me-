#Requires AutoHotkey v2.0

VERSION := "0.6"
APP_NAME := "🎵 吾韻謠"
STOP_PLAY := false
isRunning := false

MyGui := Gui(, APP_NAME)
MyGui.BackColor := "1E1E1E"
MyGui.SetFont("s10 cFFFFFF", "Segoe UI")

MyGui.Add("Text", , " ")
loopCheck := MyGui.Add("CheckBox", "vLoopCheck", "🔁 循環播放")

MyGui.Add("Text", , "🥁  演奏速度(BPM)：")
bpmList := MyGui.Add("DropDownList", "w100", ["輕快(160)", "快速(140)", "普通(120)", "抒情(90)", "極慢(60)"])
bpmList.Choose(3)

MyGui.Add("Text", , "🎵 選擇曲目：")
songList := MyGui.Add("DropDownList", "w200", ["隨機", "賓克斯的美酒", "生日快樂", "歡樂頌", "孤勇者", "小毛驢", "菊次郎之夏", "星露谷夏天小曲", "殘酷天使的行動綱領","水手之歌","鑄劍山莊(F)","清心音．亂魄抄(D)"])
songList.Choose(1)
MyGui.Add("Text", "h5", " ")

PlayBtn := MyGui.Add("Button", , "▶️  播放熱鍵：Shift+P")
PlayBtn.OnEvent("Click", PlayMusic)
StopBtn := MyGui.Add("Button", , "⏹️ 停止熱鍵：Shift+S")
StopBtn.OnEvent("Click", StopMusic)

TipBtn := MyGui.Add("Button","x220 w15 h15" , "？")
TipBtn.OnEvent("Click", Tip)

; MyGui.Add("Text", , " ")
MyGui.Add("Text", "x0 w250 Right", "version " VERSION)
MyGui.OnEvent("Close", (*) => ExitApp())
Hotkey("+p", PlayMusic)
Hotkey("+s", StopMusic)
MyGui.Show("w280 h330")

NOTE_DURATION_MAP := Map(
    "1", 4,       ; 全音符 Whole note，4 拍
    "2", 2,       ; 二分音符 Half note，2 拍
    "2.", 3,       ; 附點二分音符 Dotted half note，3 拍
    "2t", 4 / 3,     ; 二分三連音 Half triplet，約 1.33 拍（不常用）
    "4", 1,       ; 四分音符 Quarter note，1 拍
    "4.", 1.5,     ; 附點四分音符 Dotted quarter，1.5 拍
    "4t", 2 / 3,     ; 四分三連音 Quarter triplet，約 0.666 拍
    "8", 0.5,     ; 八分音符 Eighth note，0.5 拍
    "8.", 0.75,    ; 附點八分音符 Dotted eighth，0.75 拍
    "8t", 1 / 3,     ; 八分三連音 Eighth triplet，約 0.333 拍
    "16", 0.25,    ; 十六分音符 Sixteenth note，0.25 拍
    "16.", 0.375,   ; 附點十六分音符 Dotted sixteenth，0.375 拍
    "16t", 1 / 6      ; 十六分三連音 Sixteenth triplet，約 0.166 拍
)
BPM_MAP := Map(
    1, 180,
    2, 140,
    3, 120,
    4, 90,
    5, 60,
)


NOTE_KEY_MAP := Map(
    "0", "",  ; 休止符，對應空白
    "L1", "z", "L2", "x", "L3", "c", "L4", "v", "L5", "b", "L6", "n", "L7", "m",
    "M1", "a", "M2", "s", "M3", "d", "M4", "f", "M5", "g", "M6", "h", "M7", "j",
    "H1", "q", "H2", "w", "H3", "e", "H4", "r", "H5", "t", "H6", "y", "H7", "u",
    
    "M2+","K","M5+","L",
    "H2+","I"
)


score_binksSake := [
    [["M3"], "4"], [["M5"], "8"], [["M5"], "8"], [["M5"], "1"],
    [["M6"], "4"], [["M5"], "8"], [["M3"], "2"], [["M5"], "2"], [["0"], "1"],
    [["M3"], "4"], [["M5"], "8"], [["M5"], "8"], [["M5"], "1"],
    [["M6"], "4"], [["M5"], "8"], [["M3"], "2"], [["M1"], "2"], [["0"], "1"],
    [["M3"], "4"], [["M5"], "8"], [["M5"], "8"], [["M5"], "1"],
    [["M6"], "4"], [["M5"], "8"], [["M3"], "2"], [["M5"], "2"], [["0"], "1"],
    [["M3"], "4"], [["M5"], "8"], [["M5"], "8"], [["M5"], "1"],
    [["M6"], "4"], [["M5"], "8"], [["M3"], "2"], [["M1"], "2"], [["0"], "1"],
    [["M5"], "4"], [["M3"], "8"], [["M2"], "4"], [["M1"], "8"],
    [["M6"], "4"], [["M7"], "4"], [["M1"], "2"],
    [["M5"], "4"], [["M3"], "8"], [["M2"], "4"], [["M1"], "8"],
    [["M6"], "4"], [["M1"], "8"], [["M5"], "2"],
    [["M6"], "4"], [["M1"], "8"], [["M5"], "4"], [["M5"], "8"],
    [["M6"], "4"], [["M7"], "8"], [["M1"], "4"], [["M4"], "8"],
    [["M3"], "4"], [["M3"], "8"], [["M2"], "4"], [["M1"], "8"],
    [["M2"], "2"], [["0"], "2"],
    [["M5"], "4"], [["M3"], "8"], [["M2"], "4"], [["M1"], "8"],
    [["M6"], "4"], [["M7"], "4"], [["M1"], "2"],
    [["M5"], "4"], [["M3"], "8"], [["M2"], "4"], [["M1"], "8"],
    [["M6"], "4"], [["M1"], "8"], [["M5"], "2"],
    [["M6"], "4"], [["M1"], "8"], [["M5"], "2"],
    [["M6"], "4"], [["M7"], "8"], [["M1"], "4"], [["M4"], "8"],
    [["M3"], "4"], [["M1"], "8"], [["M2"], "4"], [["M2"], "8"],
    [["M1"], "2"], [["0"], "2"]
]

score_happyBirthday := [
    [["M5"], "8"], [["M5"], "8"], [["M6"], "4"], [["M5"], "4"],
    [["H1"], "4"], [["M7"], "4"], [["0"], "4"], [["M5"], "8"], [["M5"], "8"], [["M6"], "4"],
    [["M5"], "4"], [["H2"], "4"], [["H2"], "8"], [["H1"], "4"],
    [["0"], "4"], [["M5"], "8"], [["M5"], "8"],
    [["H5"], "4"], [["H3"], "4"], [["H1"], "4"], [["M7"], "4"],
    [["M6"], "4"], [["H4"], "8"], [["H4"], "4"], [["H3"], "4"],
    [["H1"], "4"], [["H2"], "4"], [["H1"], "4"], [["0"], "2"],
]
score_odeToJoy := [
    [["H3"], "8"], [["H3"], "8"], [["H4"], "8"], [["H5"], "8"],
    [["H5"], "8"], [["H4"], "8"], [["H3"], "8"], [["H2"], "8"],
    [["H1"], "8"], [["H1"], "8"], [["H2"], "8"], [["H3"], "8"],
    [["H3"], "8"], [["H2"], "8"], [["H2"], "4"], [["0"], "8"],
    [["H3"], "8"], [["H3"], "8"], [["H4"], "8"], [["H5"], "8"],
    [["H5"], "8"], [["H4"], "8"], [["H3"], "8"], [["H2"], "8"],
    [["H1"], "8"], [["H1"], "8"], [["H2"], "8"], [["H3"], "8"],
    [["H2"], "8"], [["H1"], "8"], [["H1"], "4"], [["0"], "8"],
    [["H2"], "8"], [["H2"], "8"], [["H3"], "8"], [["H1"], "8"],
    [["H2"], "8"], [["H3"], "16"], [["H4"], "16"], [["H3"], "8"], [["H1"], "8"],
    [["H2"], "8"], [["H3"], "16"], [["H4"], "16"], [["H3"], "8"], [["H2"], "8"],
    [["H1"], "8"], [["H2"], "8"], [["M6"], "8"], [["H1"], "4"], [["0"], "8"],
    [["H3"], "8"], [["H3"], "8"], [["H4"], "8"], [["H5"], "8"],
    [["H5"], "8"], [["H4"], "8"], [["H3"], "8"], [["H2"], "8"],
    [["H1"], "8"], [["H1"], "8"], [["H2"], "8"], [["H3"], "8"],
    [["H2"], "8"], [["H1"], "8"], [["H1"], "4"], [["0"], "4"]
]

score_loneWarrior := [
    [["M6"], "8"], [["M7"], "8"], [["H1"], "8"], [["H2"], "8"], [["M7"], "8"], [["H1"], "8"], [["H1"], "4"], [["H1"], "8"], [["M7"], "8"], [["H1"], "8"], [["H2"], "8"], [["M7"], "8"], [["H1"], "8"], [["H1"], "4"], [["H1"], "8"], [["H2"], "8"],
    [["H3"], "8"], [["H2"], "8"], [["H3"], "8"], [["H2"], "8"], [["H3"], "4"], [["H3"], "8"], [["H2"], "8"], [["H3"], "4"], [["H5"], "4"], [["H3"], "4"], [["M6"], "8"], [["M7"], "8"],
    [["H1"], "8"], [["H2"], "8"], [["M7"], "8"], [["H1"], "8"], [["H1"], "4"], [["H1"], "8"], [["M7"], "8"], [["H1"], "4"], [["H2"], "8"], [["M7"], "8"], [["H1"], "8"], [["H1"], "4"], [["H1"], "8"], [["H2"], "8"],
    [["H3"], "8"], [["H2"], "8"], [["H3"], "8"], [["H2"], "8"], [["H3"], "4"], [["H3"], "8"], [["H2"], "8"], [["H3"], "4"], [["H5"], "4"], [["H3"], "4"], [["M6"], "8"], [["M7"], "8"],
    [["H1"], "8"], [["H2"], "8"], [["M7"], "8"], [["H1"], "8"], [["H1"], "4"], [["H1"], "8"], [["M7"], "8"], [["H1"], "4"], [["H2"], "8"], [["M7"], "8"], [["H1"], "8"], [["H1"], "4"], [["H1"], "8"], [["H2"], "8"],
    [["H3"], "8"], [["H2"], "8"], [["H3"], "8"], [["H2"], "8"], [["H3"], "4"], [["H3"], "8"], [["H2"], "8"], [["H3"], "4"], [["H5"], "4"], [["H3"], "4"], [["H5"], "8"], [["H3"], "4"], [["H5"], "8"], [["H3"], "8"], [["H5"], "8"],
    [["H6"], "8"], [["H3"], "8"], [["H5"], "4"], [["H5"], "4"], [["H3"], "4"], [["H5"], "8"], [["H3"], "4"], [["H5"], "8"], [["H3"], "8"], [["H5"], "8"], [["H6"], "8"], [["H3"], "8"], [["H5"], "4"], [["H5"], "8"], [["H5"], "8"], [["0"], "4"],
    [["H3"], "8"], [["H2"], "8"], [["H2"], "4"], [["H2"], "4"], [["H1"], "8"], [["H3"], "8"], [["H3"], "8"], [["H2"], "8"], [["H2"], "4"], [["H2"], "4"], [["H1"], "8"], [["H1"], "8"], [["M6"], "1"], [["0"], "4"],
    [["H5"], "8"], [["H5"], "8"], [["H3"], "8"], [["H2"], "8"], [["H2"], "4"], [["H2"], "4"], [["H1"], "8"], [["H3"], "8"], [["H3"], "8"], [["H2"], "8"], [["H2"], "4"], [["H2"], "4"], [["H1"], "8"], [["H1"], "8"], [["M6"], "1"], [["0"], "2"],
]
score_donkyDonky := [
    [["M1"], "8"], [["M1"], "8"], [["M1"], "8"], [["M3"], "8"], [["M5"], "8"], [["M5"], "8"], [["M5"], "8"], [["M5"], "8"], [["M6"], "8"], [["M6"], "8"], [["M6"], "8"], [["M1"], "8"], [["M5"], "2"],
    [["M4"], "8"], [["M4"], "8"], [["M4"], "8"], [["M6"], "8"], [["M3"], "8"], [["M3"], "8"], [["M3"], "8"], [["M3"], "8"], [["M2"], "8"], [["M2"], "8"], [["M2"], "8"], [["M2"], "8"], [["M5"], "4."], [["M5"], "8"],
    [["M1"], "8"], [["M1"], "8"], [["M1"], "8"], [["M3"], "8"], [["M5"], "8"], [["M5"], "8"], [["M5"], "8"], [["M5"], "8"], [["M6"], "8"], [["M6"], "8"], [["M6"], "8"], [["H1"], "8"], [["M5"], "2"],
    [["M4"], "8"], [["M4"], "8"], [["M4"], "8"], [["M6"], "8"], [["M3"], "8"], [["M3"], "8"], [["M3"], "8"], [["M3"], "8"], [["M2"], "8"], [["M2"], "8"], [["M2"], "8"], [["M3"], "8"], [["M1"], "2"]
]
score_joeSummer := [
    [["M5"], "8"], [["H1"], "8"], [["H2"], "8"], [["H3"], "8"], [["H2"], "8"], [["H1"], "8"], [["H1"], "4."], [["0"], "8"],
    [["M5"], "8"], [["H1"], "8"], [["H2"], "8"], [["H3"], "8"], [["H2"], "8"], [["H1"], "8"], [["H2"], "4"], [["H2"], "8"], [["H3"], "8"], [["H3"], "4."], [["0"], "8"],
    [["M5"], "8"], [["H1"], "8"], [["H2"], "8"], [["H3"], "8"], [["H2"], "8"], [["H1"], "8"], [["H1"], "4."], [["0"], "8"],
    [["M5"], "8"], [["H1"], "8"], [["H2"], "8"], [["H3"], "8"], [["H2"], "8"], [["H1"], "8"], [["H2"], "4"], [["H5"], "8"], [["H3"], "4."],
    [["H3"], "8"], [["H4"], "8"], [["H5"], "8"], [["H5"], "8"], [["H5"], "4"], [["H5"], "8"], [["H5"], "8"], [["H3"], "8"], [["H1"], "4"], [["H3"], "8"], [["H4"], "8"],
    [["H5"], "8"], [["H5"], "8"], [["H5"], "4"], [["H5"], "8"], [["H5"], "8"], [["H5"], "8"], [["H3"], "8"], [["H1"], "4"], [["H1"], "8"], [["H2"], "8"],
    [["H3"], "8"], [["H3"], "8"], [["H3"], "4"], [["H3"], "8"], [["H3"], "8"], [["H3"], "8"], [["H6"], "8"], [["H6"], "8"], [["H3"], "8"], [["H2"], "8"], [["H1"], "8"], [["H2"], "4"],
    [["H2"], "8"], [["M6"], "8"], [["M6"], "8"], [["M6"], "8"], [["M7"], "8"], [["M5"], "8"], [["H1"], "8"], [["H2"], "8"], [["H3"], "8"], [["H2"], "8"], [["H1"], "8"], [["H2"], "4"],
    [["H2"], "8"], [["H3"], "4"], [["M5"], "8"], [["H1"], "8"], [["H2"], "8"], [["H3"], "8"], [["H2"], "8"], [["H1"], "8"], [["H1"], "4"], [["0"], "4"],
    [["M5"], "8"], [["H1"], "8"], [["H2"], "8"], [["H3"], "8"], [["H2"], "8"], [["H1"], "8"], [["H2"], "4"], [["H5"], "8"], [["H3"], "4"],
    [["H3"], "8"], [["H4"], "8"], [["H5"], "8"], [["H5"], "8"], [["H5"], "4"], [["H5"], "8"], [["H5"], "8"], [["H3"], "8"], [["H1"], "4"], [["H3"], "8"], [["H4"], "8"],
    [["H5"], "8"], [["H5"], "8"], [["H5"], "4"], [["H5"], "8"], [["H5"], "8"], [["H5"], "8"], [["H3"], "8"], [["H1"], "4"], [["H1"], "8"], [["H2"], "8"],
    [["H3"], "8"], [["H3"], "8"], [["H3"], "4"], [["H3"], "8"], [["H3"], "8"], [["H3"], "8"], [["H6"], "8"], [["H3"], "8"], [["H2"], "8"], [["H1"], "8"], [["M6"], "8"], [["H1"], "2"],
]
score_stardewValleySummer := [
    [["M7"], "16"], [["H1"], "16"], [["H2"], "8"], [["M7"], "8"],
    [["H2"], "16"], [["H3"], "16"], [["H2"], "16"], [["H3"], "16"], [["H2"], "16"], [["H1"], "16"], [["H2"], "8"], [["M7"], "8"], [["M5"], "8."], [["0"], "8"],
    [["M5"], "8"], [["M7"], "8"], [["M5"], "16"], [["H1"], "16"], [["M7"], "16"], [["H1"], "8"], [["H1"], "16"], [["H3"], "16"], [["H2"], "8."], [["0"], "8"],
    [["M7"], "16"], [["H1"], "16"], [["H2"], "8"], [["M7"], "8"], [["H2"], "16"], [["H3"], "16"], [["H2"], "16"], [["H3"], "16"], [["H2"], "16"], [["H1"], "16"], [["H2"], "8"], [["M7"], "8"], [["M5"], "8."], [["0"], "8"],
    [["M5"], "8"], [["M7"], "8"], [["M5"], "16"], [["H1"], "16"], [["H1"], "16"], [["M7"], "8"], [["M6"], "16"], [["M5"], "8."], [["0"], "8."],
    [["M7"], "16"], [["H1"], "16"], [["H2"], "8"], [["M7"], "8"], [["H2"], "16"], [["H3"], "16"], [["H2"], "16"], [["H3"], "16"], [["H2"], "16"], [["H1"], "16"], [["H2"], "8"], [["M7"], "8"], [["M5"], "8."], [["0"], "8"],
    [["M5"], "8"], [["M7"], "8"], [["M5"], "16"], [["H1"], "16"], [["M7"], "16"], [["H1"], "8"], [["H1"], "16"], [["H3"], "16"], [["H2"], "16."], [["0"], "8"],
    [["M7"], "16"], [["H1"], "16"], [["H2"], "8"], [["M7"], "8"], [["H2"], "16"], [["H3"], "16"], [["H2"], "16"], [["H3"], "16"], [["H2"], "16"], [["H1"], "16"], [["H2"], "8"], [["M7"], "8"], [["M5"], "8."], [["0"], "8"],
    [["M5"], "8"], [["M7"], "8"], [["M5"], "16"], [["H1"], "16"], [["H1"], "16"], [["M7"], "8"], [["M6"], "16"], [["M5"], "2"]
]
score_theCruelAngel := [
    [["M6"], "8."], [["H1"], "8."], [["H2"], "8"], [["H1"], "4"], [["H2"], "8"], [["H2"], "8"], [["H2"], "8"], [["H5"], "8"], [["H4"], "8"], [["H3"], "8"], [["H2"], "8"], [["H3"], "4"], [["H3"], "8"],
    [["H5"], "8"], [["H6"], "8"], [["H2"], "4"], [["H1"], "8"], [["M7"], "8"], [["M7"], "8"], [["M6"], "8"], [["M7"], "8"], [["H2"], "8"], [["H1"], "8"], [["H1"], "2."], [["0"], "8"],
    [["M6"], "8"], [["H1"], "8"], [["H2"], "8"], [["H1"], "4"], [["H2"], "8"], [["H2"], "8"], [["H2"], "8"], [["H5"], "8"], [["H4"], "8"], [["H3"], "8"], [["H2"], "8"], [["H3"], "4"], [["H3"], "8"],
    [["H5"], "8"], [["H6"], "8"], [["H2"], "4"], [["H1"], "8"], [["H5"], "8"], [["H5"], "8"], [["H3"], "8"], [["H5"], "8"], [["H5"], "8"], [["H6"], "2."], [["0"], "8"],
    [["M6"], "8"], [["H1"], "8"], [["H2"], "8"], [["H1"], "4"], [["H2"], "8"], [["H2"], "8"], [["H2"], "8"], [["H5"], "8"], [["H4"], "8"], [["H3"], "8"], [["H2"], "8"], [["H3"], "4"], [["H3"], "8"],
    [["H5"], "8"], [["H6"], "8"], [["H2"], "4"], [["H1"], "8"], [["H5"], "8"], [["H5"], "8"], [["H3"], "8"], [["H5"], "8"], [["H5"], "8"], [["H6"], "1"]
]
score_wellerman :=[
    [["H3"], "4"],[["M6"], "8"],[["M6"], "8"],[["M6"], "8"],[["H1"], "16"],[["H3"], "8"],[["H3"], "8"],[["H3"], "8"],[["H3"], "16"],[["H3"], "16"],
    [["H4"], "8"],[["H2"], "8"],[["H2"], "8"],[["H4"], "8"],[["H4"], "16"],[["H6"], "16"],[["H3"], "16"],[["H3"], "16"],[["H3"], "8."],[["H3"], "16"],
    [["M6"], "8"], [["M6"], "8"], [["H1"], "8"], [["H2"], "8"], [["H3"], "8"], [["H3"], "8"], [["H3"], "8"], [["H1"], "16"], [["H3"], "8"], [["H2"], "8"], [["H1"], "8"], [["M7"], "8"], [["M6"], "4"], [["0"], "4"],
    [["H6"], "4"], [["H6"], "8."],[["H4"], "16"], [["H5"], "8"],[["H3"], "8"], [["H3"], "8."], [["H3"], "16"], [["H4"], "8"], [["H2"], "8"], [["H2"], "16"], [["H3"], "16"], [["H4"], "8"], [["H3"], "8"], [["H1"], "8"], [["M6"], "4"],
    [["H6"], "4"],[["H6"], "8."],[["H4"], "16"],[["H5"], "8"],[["H3"], "8"],[["H3"], "8"],[["H3"], "16"],[["H3"], "8"],[["H2"], "8"],[["H1"], "8"],[["M7"], "8"],[["M6"], "4"],[["0"], "4"],
]
score_swordForgingVilla :=[
    [["L6"], "8"],[["L5"], "8"],[["L6"], "2"],[["0"], "8"],[["M1"], "8"],[["M2"], "8"],[["M3"], "2"],[["0"], "4"],[["M6"], "8"],[["M5"], "8"],[["M6"], "2"],[["0"], "8"],
    [["H1"], "8"],[["M6"], "8"],[["M5"], "8"],[["M3"], "4"],[["0"], "2"],[["M6"], "8"],[["M5"], "8"],[["M6"], "2"],[["0"], "8"],[["M6"], "8"],[["M5"], "8"],[["M3"], "8"],[["M2"], "1"],[["0"], "8"],
    [["M2"], "2"],[["M3"], "8"],[["L7"], "8"],[["L5"], "8"],[["L6"], "2."],[["0"], "8"],[["L6"], "8"],[["L5"], "8"],[["L6"], "2"],[["0"], "8"],[["M1"], "8"],[["M2"], "8"],[["M3"], "2"],[["0"], "8"],
    [["M6"], "8"],[["M5"], "8"],[["M6"], "2"],[["0"], "8"],[["H1"], "8"],[["M6"], "8"],[["M5"], "8"],[["M3"], "2"],[["0"], "8"],
    [["M6"], "8"],[["M5"], "8"],[["M6"], "2"],[["0"], "8"],[["M6"], "8"],[["M5"], "8"],[["M3"], "8"],[["M2"], "2."],[["0"], "8"],
    [["M2"], "2"],[["0"], "8"],[["M3"], "8"],[["L7"], "8"],[["L5"], "8"],[["L6"], "2"],[["L6"], "8"],[["M3"], "8"],[["H1"], "8"],[["M7"], "8"],
    [["M6"], "4."],[["H1"], "8"],[["M6"], "4"],[["H1"], "8"],[["M6"], "4"],[["M5"], "4."],[["M3"], "8"],[["M5"], "2"],[["0"], "8"],
    [["M6"], "4."],[["H1"], "8"],[["M6"], "8"],[["M5"], "8"],[["M2"], "8"],[["M4"], "8"],[["M3"], "2."],[["M2"], "8"],[["M3"], "8"],
    [["M5"], "4."],[["M6"], "8"],[["M5"], "4"],[["M5"], "8"],[["M3"], "8"],[["M2"], "4."],[["M3"], "8"],[["L6"], "2"],
    [["M6"], "8"],[["M5"], "8"],[["M6"], "8"],[["H1"], "8"],[["H2"], "8"],[["H1"], "8"],[["M7"], "8"],[["M5"], "8"],[["M6"], "1"],
]
score_clearHeart :=[
    [["H1"],"2."],[["H2"],"8"],[["H5"],"8"],[["H3"],"1"],[["H1"],"2."],[["H2"],"8"],[["M6"],"8"],[["M5"],"1"],
    [["H1"],"2."],[["H2"],"8"],[["H5"],"8"],[["H3"],"4"],[["H5"],"4"],[["H3"],"4"],[["H1"],"8"],[["M6"],"8"],
    [["H2"],"2."],[["H2"],"1"],[["H1"],"2."],[["H2"],"8"],[["H5"],"8"],[["H3"],"1"],[["H1"],"2."],[["H2"],"8"],[["M6"],"8"],[["M5"],"1"],
    [["H1"],"2."],[["H2"],"8"],[["H5"],"8"],[["H3"],"2"],[["H1"],"8"],[["H2"],"8"],[["M6"],"8"],[["M5"],"8"],[["H1"],"2."],
    [["H1"],"1"],[["H1"],"2"],[["H2"],"4"],[["H3"],"4"],[["M7"],"1"],
    [["0"],"4"],[["M6"],"4"],[["H1"],"2"],[["0"],"4"],[["M5"],"4"],[["H1"],"2"],[["0"],"4"],[["M6"],"4"],[["H1"],"4"],[["H3"],"4"],
    [["H2"],"2."],[["H2"],"1"],[["H1"],"2."],[["H2"],"8"],[["H5"],"8"],[["H3"],"1"],[["H1"],"2."],[["H2"],"8"],[["M6"],"8"],[["M5"],"1"],
    [["H1"],"2."],[["H2"],"8"],[["H5"],"8"],[["H3"],"4"],[["H5"],"4"],[["H3"],"4"],[["H1"],"8"],[["M6"],"8"],[["H2"],"2."],[["H2"],"1"],
    [["H1"],"2."],[["H2"],"8"],[["H5"],"8"],[["H3"],"1"],[["H1"],"2."],[["H2"],"8"],[["M6"],"8"],[["M5"],"1"],[["H1"],"2."],[["H2"],"8"],[["H5"],"8"],
    [["H3"],"2"],[["H1"],"8"],[["H2"],"8"],[["M6"],"8"],[["M5"],"8"],[["H1"],"2."],[["H1"],"1"],

    [["L1"],"4"],[["M5"],"8"],[["M6"],"8"],[["M5"],"2"],[["L1"],"4"],[["M5"],"8"],[["M6"],"8"],[["M5"],"2"],[["L1"],"4"],[["M5"],"8"],[["M5+"],"8"],[["M5"],"2"],
    [["M1"],"4"],[["M2"],"8"],[["M2+"],"4"],[["M5"],"8"],[["M5+"],"8"],[["M5"],"8"],[["M5+"],"16"],[["M5"],"16"],[["M2+"],"8"],[["M2"],"8"],[["M1"],"2"],
    [["M5"],"8"],[["M2+"],"8"],[["M5"],"8"],[["M5+"],"8"],[["H1"],"4"],[["H2"],"16"],[["H1"],"16"],[["M5+"],"8"],[["M5"],"1"],
    [["M4"],"4"],[["M5"],"8"],[["M5+"],"8"],[["M4"],"8"],[["M5+"],"8"],[["H1"],"8"],[["M5"],"8"],[["M5"],"16"],[["M2+"],"16"],[["M2"],"8"],[["M1"],"8"],[["M2"],"2"],
    [["M1"],"8"],[["M2+"],"8"],[["M5"],"8"],[["M5+"],"8"],[["M5"],"8"],[["M5+"],"16"],[["M5"],"16"],[["M2+"],"8"],[["M2"],"8"],[["M1"],"1"],
    [["H1"],"4."],[["M5"],"8"],[["H1"],"8"],[["M5"],"8"],[["H1"],"8"],[["H2"],"8"],[["H2+"],"8"],[["H2"],"8"],[["H1"],"8"],[["M5+"],"8"],[["M5"],"2"],
    [["M4"],"4"],[["M5"],"8"],[["M5+"],"8"],[["H1"],"4"],[["H2"],"16"],[["H1"],"16"],[["M5+"],"8"],[["M5"],"1"],
    [["H1"],"4"],[["H1"],"8"],[["M5+"],"8"],[["M5"],"8"],[["M5+"],"8"],[["M5"],"8"],[["M2+"],"8"],[["M2"],"8"],[["M2"],"16"],[["M2+"],"16"],[["M2"],"8"],[["M1"],"8"],[["M2"],"2"],
    [["M1"],"8"],[["M5"],"16"],[["M5"],"16"],[["M5"],"8"],[["M5+"],"8"],[["M5"],"8"],[["M5+"],"16"],[["M5"],"16"],[["M2+"],"8"],[["M2"],"8"],
    
    [["M1"],"1"],[["M1"],"8"],[["M5"],"16"],[["M5"],"16"],[["M5+"],"8"],[["M5"],"8"],[["M5"],"8"],[["M5"],"16"],[["M5+"],"16"],[["M5"],"8"],[["M4"],"8"],[["M5"],"1"],
    [["H1"],"2."],[["H2"],"8"],[["H5"],"8"],[["H3"],"1"],[["H1"],"2."],[["H2"],"8"],[["M6"],"8"],[["M5"],"1"],[["H1"],"2."],[["H2"],"8"],[["H5"],"8"],
    [["H3"],"4"],[["H5"],"4"],[["H3"],"4"],[["H1"],"8"],[["M6"],"8"],[["H2"],"1"],[["H2"],"1"],[["H1"],"2."],[["H2"],"8"],[["H5"],"8"],
    [["H3"],"1"],[["H1"],"2."],[["H2"],"8"],[["M6"],"8"],[["M5"],"1"],[["H1"],"1"],
    [["H2"],"8"],[["H5"],"8"],[["H3"],"2"],[["H1"],"8"],[["H2"],"8"],[["M6"],"8"],[["M5"],"8"],[["H1"],"1"],

]

SCORE_MAP := Map(
    2, score_binksSake,
    3, score_happyBirthday,
    4, score_odeToJoy,
    5, score_loneWarrior,
    6, score_donkyDonky,
    7, score_joeSummer,
    8, score_stardewValleySummer,
    9, score_theCruelAngel,
    10, score_wellerman,
    11, score_swordForgingVilla,
    12, score_clearHeart
)

; ===============================================================================================
; ===============================================================================================
; ===============================================================================================


PlayMusic(*) {
    global SCORE_MAP, isRunning, STOP_PLAY

    if (isRunning)
        return

    isRunning := true
    STOP_PLAY := false  ; 播放前先重置中斷旗標

    Loop {
        selectedId := songList.Value

        ; 如果是隨機播放（選單值為 1）
        if (selectedId = 1) {
            keys := []
            for key, _ in SCORE_MAP {
                keys.Push(key)
            }
            randomIndex := Random(1, keys.Length)
            selectedId := keys[randomIndex]
        }

        ; 播放選定的樂譜
        if SCORE_MAP.Has(selectedId) {
            Sleep(150)
            musicSheet := SCORE_MAP[selectedId]
            PlayMusicSheet(musicSheet)
            Sleep(250)
        } else {
            MsgBox("⚠️ 找不到對應曲目！")
        }

        ; 檢查是否需要迴圈播放
        if (!loopCheck.Value)
            break
    }

    isRunning := false
}

StopMusic(*) {
    ; MsgBox "⏹️ 停止播放"
    global STOP_PLAY, isRunning
    isRunning := false
    STOP_PLAY := true
    return
}


PlayMusicSheet(sheet) {
    global NOTE_KEY_MAP, NOTE_DURATION_MAP, STOP_PLAY, BPM_MAP

    for _, item in sheet {
        if (STOP_PLAY) {
            break
        }
        ; 查詢用戶選擇的BPM
        selectedIndex := bpmList.Value
        BPM := BPM_MAP[selectedIndex]
        BEAT_DURATION := 60000 / BPM

        notes := item[1]
        durationName := item[2]
        durationMs := BEAT_DURATION * NOTE_DURATION_MAP[durationName]

        ; 播放每個音符
        for _, note in notes {
            key := NOTE_KEY_MAP.Has(note) ? NOTE_KEY_MAP[note] : ""
            if (key != "") {
                Send("{Blind}{" key " down}")
            }
        }

        ; 檢查中斷（避免 Sleep 無法提早結束）
        interval := 50
        timePassed := 0
        while (timePassed < durationMs) {
            if (STOP_PLAY)
                break
            Sleep(interval)
            timePassed += interval
        }

        ; 放開按鍵
        for _, note in notes {
            key := NOTE_KEY_MAP.Has(note) ? NOTE_KEY_MAP[note] : ""
            if (key != "") {
                Send("{Blind}{" key " up}")
                ; 短暫間隔
                Sleep(BEAT_DURATION * 0.05)
            }
        }
    }
}

Tip(*){
    MsgBox("由於程式會模擬按鍵操作`n這類功能需要較高的系統權限`n`n因此請以「系統管理員」身份來執行程式`n才能確保功能正常運作。")
    MsgBox("若是付費拿到此軟體`n你可能被騙了")
}